<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FastShip HU - Customer Example</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    h1,
    h2,
    h3 {
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input,
    button,
    select,
    textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    input,
    textarea,
    select {
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #f8f8f8;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .warning {
      background-color: #fff3cd;
      color: #856404;
    }

    .info {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .log-container {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
      font-family: monospace;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }

    .log-timestamp {
      color: #666;
      font-size: 0.8em;
    }

    .button-group {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .primary-btn {
      background-color: #007bff;
    }

    .cancel-btn {
      background-color: #dc3545;
    }

    .order-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }

    .order-id {
      font-weight: bold;
      color: #007bff;
    }

    .tab-container {
      margin-bottom: 20px;
    }

    .tab-buttons {
      display: flex;
      margin-bottom: 10px;
    }

    .tab-button {
      padding: 10px 15px;
      cursor: pointer;
      background-color: #f1f1f1;
      border: none;
      margin-right: 5px;
      border-radius: 4px 4px 0 0;
    }

    .tab-button.active {
      background-color: #4CAF50;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 0 0 4px 4px;
    }

    .tab-content.active {
      display: block;
    }

    .progress-container {
      margin: 20px 0;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
      padding-bottom: 20px;
    }

    .progress-step::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 4px;
      background-color: #ddd;
      top: 25px;
      left: 50%;
      z-index: 1;
    }

    .progress-step:last-child::before {
      display: none;
    }

    .progress-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }

    .progress-circle.active {
      background-color: #4CAF50;
      color: white;
    }

    .progress-text {
      margin-top: 10px;
      font-size: 12px;
    }

    #location-inputs,
    #items-container {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .item-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .remove-item {
      background-color: #dc3545;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>FastShip HU - Customer Example</h1>

    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab('login-tab')">Login</button>
        <button class="tab-button" onclick="openTab('socket-tab')">Socket</button>
        <button class="tab-button" onclick="openTab('order-tab')">Create Order</button>
        <button class="tab-button" onclick="openTab('tracking-tab')">Order Tracking</button>
        <button class="tab-button" onclick="openTab('logs-tab')">Logs</button>
      </div>

      <div id="login-tab" class="tab-content active">
        <h2>Login</h2>
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="text" id="phone" value="+84979797979" placeholder="Enter phone number">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" value="123456" placeholder="Enter password">
        </div>
        <button id="login-btn" onclick="login()">Login</button>
        <div id="login-status" class="status"></div>
      </div>

      <div id="socket-tab" class="tab-content">
        <h2>Socket Connection</h2>
        <div class="form-group">
          <label for="server-url">Server URL</label>
          <input type="text" id="server-url" value="http://localhost:3000" placeholder="Enter server URL">
        </div>
        <button id="connect-btn" onclick="connectSocket()">Connect Socket</button>
        <button id="disconnect-btn" onclick="disconnectSocket()" disabled>Disconnect</button>
        <div id="socket-status" class="status"></div>
      </div>

      <div id="order-tab" class="tab-content">
        <h2>Create Order</h2>
        <div id="location-inputs">
          <div class="form-group">
            <label for="pickup-address">Pickup Address</label>
            <input type="text" id="pickup-address" value="Andrássy út 39, Budapest, Hungary"
              placeholder="Enter pickup address">
          </div>
          <div class="form-group">
            <label for="pickup-lat">Pickup Latitude</label>
            <input type="number" id="pickup-lat" value="47.502" step="0.000001" placeholder="Latitude">
          </div>
          <div class="form-group">
            <label for="pickup-lng">Pickup Longitude</label>
            <input type="number" id="pickup-lng" value="19.057" step="0.000001" placeholder="Longitude">
          </div>

          <div class="form-group">
            <label for="delivery-address">Delivery Address</label>
            <input type="text" id="delivery-address" value="Váci utca 1, Budapest, Hungary"
              placeholder="Enter delivery address">
          </div>
          <div class="form-group">
            <label for="delivery-lat">Delivery Latitude</label>
            <input type="number" id="delivery-lat" value="47.496" step="0.000001" placeholder="Latitude">
          </div>
          <div class="form-group">
            <label for="delivery-lng">Delivery Longitude</label>
            <input type="number" id="delivery-lng" value="19.050" step="0.000001" placeholder="Longitude">
          </div>
        </div>

        <h3>Order Items</h3>
        <div id="items-container">
          <div class="item-row" id="item-1">
            <input type="text" placeholder="Item name" value="Hamburger">
            <input type="number" placeholder="Quantity" value="2" min="1" style="width: 80px;">
            <input type="number" placeholder="Price" value="10" min="0" style="width: 80px;">
            <button class="remove-item" onclick="removeItem('item-1')">×</button>
          </div>
        </div>
        <button onclick="addItem()">Add Item</button>

        <div class="form-group">
          <label for="order-notes">Notes</label>
          <textarea id="order-notes" placeholder="Special instructions, etc.">Please deliver quickly</textarea>
        </div>

        <button id="create-order-btn" class="primary-btn" onclick="createOrder()">Create Order</button>
        <div id="order-status" class="status"></div>
      </div>

      <div id="tracking-tab" class="tab-content">
        <h2>Order Tracking</h2>
        <div id="no-orders" class="status info">No active orders to track</div>

        <div id="active-order" style="display: none;">
          <div class="order-card">
            <h3>Active Order Details</h3>
            <div id="order-details"></div>

            <div class="progress-container">
              <h4>Order Progress</h4>
              <div class="progress-steps">
                <div class="progress-step">
                  <div class="progress-circle" id="progress-pending">1</div>
                  <div class="progress-text">Order Placed</div>
                </div>
                <div class="progress-step">
                  <div class="progress-circle" id="progress-finding">2</div>
                  <div class="progress-text">Finding Driver</div>
                </div>
                <div class="progress-step">
                  <div class="progress-circle" id="progress-accepted">3</div>
                  <div class="progress-text">Driver Accepted</div>
                </div>
                <div class="progress-step">
                  <div class="progress-circle" id="progress-picked">4</div>
                  <div class="progress-text">Order Picked Up</div>
                </div>
                <div class="progress-step">
                  <div class="progress-circle" id="progress-delivered">5</div>
                  <div class="progress-text">Delivered</div>
                </div>
              </div>
            </div>

            <div id="driver-info" style="display: none;">
              <h4>Driver Information</h4>
              <div id="driver-details"></div>
            </div>

            <div class="button-group">
              <button id="cancel-order-btn" class="cancel-btn" onclick="cancelOrder()">Cancel Order</button>
            </div>
          </div>
        </div>
      </div>

      <div id="logs-tab" class="tab-content">
        <h2>Event Logs</h2>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="log-container" class="log-container"></div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let socket;
    let accessToken = '';
    let customerId = null;
    let activeOrder = null;
    let itemCount = 1;

    // Order process statuses
    const OrderProcessStatus = {
      PENDING: 'pending',
      FIND_DRIVER: 'findDriver',
      DRIVER_ACCEPTED: 'driverAccepted',
      STORE_ACCEPTED: 'storeAccepted',
      DRIVER_ARRIVED_STORE: 'driverArrivedStore',
      DRIVER_PICKED: 'driverPicked',
      DRIVER_ARRIVED_DESTINATION: 'driverArrivedDestination',
      COMPLETED: 'completed',
      CANCELLED: 'cancelled'
    };

    // Tab navigation
    function openTab (tabId) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }

      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }

      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // Login function
    async function login () {
      const phone = document.getElementById('phone').value;
      const password = document.getElementById('password').value;
      const loginStatus = document.getElementById('login-status');

      if (!phone || !password) {
        loginStatus.innerHTML = 'Please enter phone number and password';
        loginStatus.className = 'status error';
        return;
      }

      loginStatus.innerHTML = 'Logging in...';
      loginStatus.className = 'status';

      try {
        const response = await fetch('https://zennail23.com/api/v1/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': '',
            'accept': '*/*'
          },
          body: JSON.stringify({
            phone: phone,
            password: password,
            type: 1 // Customer type
          })
        });

        const data = await response.json();

        if (data.status === true && data.data && data.data.access_token) {
          accessToken = data.data.access_token;
          loginStatus.innerHTML = 'Login successful! Token: ' + accessToken.substring(0, 10) + '...';
          loginStatus.className = 'status success';
          addLog('Login successful', 'success');

          // Auto switch to socket tab
          setTimeout(() => {
            openTab('socket-tab');
          }, 1000);
        } else {
          loginStatus.innerHTML = 'Login failed: ' + (data.message || 'Unknown error');
          loginStatus.className = 'status error';
          addLog('Login failed: ' + (data.message || 'Unknown error'), 'error');
        }
      } catch (error) {
        loginStatus.innerHTML = 'Error: ' + error.message;
        loginStatus.className = 'status error';
        addLog('Login error: ' + error.message, 'error');
      }
    }

    // Connect to socket server
    function connectSocket () {
      if (!accessToken) {
        document.getElementById('socket-status').innerHTML = 'Please login first to get access token';
        document.getElementById('socket-status').className = 'status error';
        addLog('Socket connection failed: No access token', 'error');
        return;
      }

      const serverUrl = document.getElementById('server-url').value;

      try {
        // Initialize Socket.IO connection
        socket = io(serverUrl, {
          transports: ['websocket'],
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000
        });

        // Connection events
        socket.on('connect', () => {
          document.getElementById('socket-status').innerHTML = 'Connected to server. Socket ID: ' + socket.id;
          document.getElementById('socket-status').className = 'status success';
          document.getElementById('connect-btn').disabled = true;
          document.getElementById('disconnect-btn').disabled = false;
          addLog('Socket connected. Socket ID: ' + socket.id, 'success');

          // Authenticate customer
          socket.emit('authenticate_customer', { token: accessToken });
        });

        socket.on('disconnect', (reason) => {
          document.getElementById('socket-status').innerHTML = 'Disconnected from server. Reason: ' + reason;
          document.getElementById('socket-status').className = 'status error';
          document.getElementById('connect-btn').disabled = false;
          document.getElementById('disconnect-btn').disabled = true;
          addLog('Socket disconnected. Reason: ' + reason, 'error');
        });

        socket.on('connect_error', (error) => {
          document.getElementById('socket-status').innerHTML = 'Connection error: ' + error.message;
          document.getElementById('socket-status').className = 'status error';
          addLog('Socket connection error: ' + error.message, 'error');
        });

        // Authentication events
        socket.on('authentication_success', (response) => {
          addLog('Authentication successful: ' + JSON.stringify(response.data), 'success');
          customerId = response.data.customerId;

          document.getElementById('socket-status').innerHTML = 'Authenticated as Customer ID: ' + customerId;

          // Auto switch to order creation tab
          setTimeout(() => {
            openTab('order-tab');
          }, 1000);
        });

        socket.on('authentication_error', (response) => {
          addLog('Authentication error: ' + response.message, 'error');
          document.getElementById('socket-status').innerHTML = 'Authentication failed: ' + response.message;
          document.getElementById('socket-status').className = 'status error';
        });

        // Order-related events
        socket.on('create_order_result', (response) => {
          addLog('Order result received: ' + JSON.stringify(response.data), 'success');
          const orderId = response.data.id;
          const processStatus = response.data.process_status;

          if (!activeOrder) {
            // Nếu đây là đơn hàng mới
            activeOrder = {
              id: orderId,
              process_status: processStatus,
              // Lấy thông tin khác từ form
              pickup_address: document.getElementById('pickup-address').value,
              pickup_lat: parseFloat(document.getElementById('pickup-lat').value),
              pickup_lng: parseFloat(document.getElementById('pickup-lng').value),
              delivery_address: document.getElementById('delivery-address').value,
              delivery_lat: parseFloat(document.getElementById('delivery-lat').value),
              delivery_lng: parseFloat(document.getElementById('delivery-lng').value),
              distance: calculateDistance(
                parseFloat(document.getElementById('pickup-lat').value),
                parseFloat(document.getElementById('pickup-lng').value),
                parseFloat(document.getElementById('delivery-lat').value),
                parseFloat(document.getElementById('delivery-lng').value)
              ).toFixed(2),
              created_at: new Date().toISOString()
            };
          } else {
            // Cập nhật thông tin đơn hàng
            activeOrder.process_status = processStatus;

            // Nếu tìm thấy tài xế
            if (response.data.find_driver_status === 'found' && response.data.driverInfo) {
              activeOrder.driver = response.data.driverInfo;
            }
          }

          updateOrderDisplay();

          // Chuyển đến tab theo dõi đơn hàng
          openTab('tracking-tab');
        });

        socket.on('order_status_updated', (response) => {
          addLog('Order status updated: ' + JSON.stringify(response.data), 'info');
          if (activeOrder && activeOrder.id === response.data.orderId) {
            activeOrder.process_status = response.data.processStatus;
            updateOrderDisplay();
          }
        });

        socket.on('driver_location_update', (response) => {
          addLog('Driver location updated: ' + JSON.stringify(response.data), 'info');
          // Có thể cập nhật vị trí tài xế trên bản đồ nếu có
        });

        socket.on('order_completed', (response) => {
          addLog('Order completed: ' + JSON.stringify(response.data), 'success');
          if (activeOrder && activeOrder.id === response.data.orderId) {
            activeOrder.process_status = OrderProcessStatus.COMPLETED;
            updateOrderDisplay();

            // Sau một thời gian, xóa đơn hàng khỏi màn hình
            setTimeout(() => {
              activeOrder = null;
              updateOrderDisplay();
            }, 10000);
          }
        });

        socket.on('order_cancelled', (response) => {
          addLog('Order cancelled: ' + JSON.stringify(response.data), 'warning');
          if (activeOrder && activeOrder.id === response.data.orderId) {
            activeOrder.process_status = OrderProcessStatus.CANCELLED;
            updateOrderDisplay();

            // Sau một thời gian, xóa đơn hàng khỏi màn hình
            setTimeout(() => {
              activeOrder = null;
              updateOrderDisplay();
            }, 10000);
          }
        });

        socket.on('driver_rejected_order', (response) => {
          addLog('Driver rejected order: ' + JSON.stringify(response.data), 'warning');
          // Thông báo cho người dùng tài xế đã từ chối đơn
        });

        // Bắt các lỗi
        socket.on('error', (response) => {
          addLog('Error: ' + JSON.stringify(response), 'error');
        });

      } catch (error) {
        document.getElementById('socket-status').innerHTML = 'Error initializing socket: ' + error.message;
        document.getElementById('socket-status').className = 'status error';
        addLog('Socket initialization error: ' + error.message, 'error');
      }
    }

    // Disconnect from socket server
    function disconnectSocket () {
      if (socket) {
        socket.disconnect();

        // Update UI
        document.getElementById('connect-btn').disabled = false;
        document.getElementById('disconnect-btn').disabled = true;
        document.getElementById('socket-status').innerHTML = 'Disconnected from server';
        document.getElementById('socket-status').className = 'status warning';
      }
    }

    // Add a new item row
    function addItem () {
      itemCount++;
      const itemId = 'item-' + itemCount;

      const itemRow = document.createElement('div');
      itemRow.className = 'item-row';
      itemRow.id = itemId;

      itemRow.innerHTML = `
                <input type="text" placeholder="Item name">
                <input type="number" placeholder="Quantity" value="1" min="1" style="width: 80px;">
                <input type="number" placeholder="Price" value="0" min="0" style="width: 80px;">
                <button class="remove-item" onclick="removeItem('${itemId}')">×</button>
            `;

      document.getElementById('items-container').appendChild(itemRow);
    }

    // Remove an item row
    function removeItem (itemId) {
      const item = document.getElementById(itemId);
      if (item) {
        item.remove();
      }
    }

    // Create a new order
    function createOrder () {
      if (!socket || !socket.connected) {
        const orderStatus = document.getElementById('order-status');
        orderStatus.innerHTML = 'Cannot create order: Socket not connected';
        orderStatus.className = 'status error';
        addLog('Cannot create order: Socket not connected', 'error');
        return;
      }

      // Get location data
      const pickupAddress = document.getElementById('pickup-address').value;
      const pickupLat = parseFloat(document.getElementById('pickup-lat').value);
      const pickupLng = parseFloat(document.getElementById('pickup-lng').value);

      const deliveryAddress = document.getElementById('delivery-address').value;
      const deliveryLat = parseFloat(document.getElementById('delivery-lat').value);
      const deliveryLng = parseFloat(document.getElementById('delivery-lng').value);

      // Get order items
      const itemRows = document.querySelectorAll('.item-row');
      const items = [];
      let totalAmount = 0;

      itemRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const name = inputs[0].value.trim();
        const quantity = parseInt(inputs[1].value);
        const price = parseFloat(inputs[2].value);

        if (name && quantity > 0) {
          items.push({
            name,
            quantity,
            price
          });

          totalAmount += price * quantity;
        }
      });

      if (items.length === 0) {
        const orderStatus = document.getElementById('order-status');
        orderStatus.innerHTML = 'Please add at least one item';
        orderStatus.className = 'status error';
        return;
      }

      // Get notes
      const notes = document.getElementById('order-notes').value;

      // Calculate distance (simple straight-line distance for demonstration)
      const distance = calculateDistance(pickupLat, pickupLng, deliveryLat, deliveryLng);

      // Create order object
      const order = {
        id: 'ORD-' + Date.now(), // Tạm thời, server sẽ tạo ID chính thức
        customer_id: customerId,
        pickup_address: pickupAddress,
        pickup_lat: pickupLat,
        pickup_lng: pickupLng,
        delivery_address: deliveryAddress,
        delivery_lat: deliveryLat,
        delivery_lng: deliveryLng,
        items: items,
        notes: notes,
        distance: distance.toFixed(2),
        currency: 'EUR',
        price: totalAmount.toFixed(2),
        status: 'new',
        created_at: new Date().toISOString(),
        accessToken: accessToken // Gửi kèm token để server xác thực
      };

      // Send order to server
      socket.emit('create_order', order);

      const orderStatus = document.getElementById('order-status');
      orderStatus.innerHTML = 'Order created and sent to server...';
      orderStatus.className = 'status info';

      addLog('Order created and sent to server: ' + JSON.stringify(order), 'info');

      // For demo purposes, we'll set the activeOrder directly
      // In a real application, we would wait for server confirmation
      activeOrder = order;
      activeOrder.process_status = OrderProcessStatus.PENDING;
      updateOrderDisplay();

      // Switch to tracking tab
      setTimeout(() => {
        openTab('tracking-tab');
      }, 1000);
    }

    // Update the order display
    function updateOrderDisplay () {
      const noOrdersElement = document.getElementById('no-orders');
      const activeOrderElement = document.getElementById('active-order');

      if (!activeOrder) {
        noOrdersElement.style.display = 'block';
        activeOrderElement.style.display = 'none';
        return;
      }

      noOrdersElement.style.display = 'none';
      activeOrderElement.style.display = 'block';

      // Update order details
      const orderDetails = document.getElementById('order-details');
      orderDetails.innerHTML = `
                <div><strong class="order-id">Order ID: ${activeOrder.id}</strong></div>
                <div><strong>Status:</strong> ${activeOrder.process_status || 'Pending'}</div>
                <div><strong>Pickup:</strong> ${activeOrder.pickup_address}</div>
                <div><strong>Delivery:</strong> ${activeOrder.delivery_address}</div>
                <div><strong>Distance:</strong> ${activeOrder.distance} km</div>
                <div><strong>Price:</strong> ${activeOrder.price} ${activeOrder.currency}</div>
                <div><strong>Created:</strong> ${new Date(activeOrder.created_at).toLocaleString()}</div>
            `;

      // Update progress circles
      const progressSteps = [
        { id: 'progress-pending', status: OrderProcessStatus.PENDING },
        { id: 'progress-finding', status: OrderProcessStatus.FIND_DRIVER },
        { id: 'progress-accepted', status: OrderProcessStatus.DRIVER_ACCEPTED },
        { id: 'progress-picked', status: OrderProcessStatus.DRIVER_PICKED },
        { id: 'progress-delivered', status: OrderProcessStatus.COMPLETED }
      ];

      let currentStepReached = false;

      progressSteps.forEach(step => {
        const element = document.getElementById(step.id);

        // Reset class
        element.className = 'progress-circle';

        // Check if this step is active or past
        if (!currentStepReached) {
          if (activeOrder.process_status === step.status) {
            element.classList.add('active');
            currentStepReached = true;
          } else if (
            (step.status === OrderProcessStatus.PENDING) ||
            (step.status === OrderProcessStatus.FIND_DRIVER && activeOrder.process_status !== OrderProcessStatus.PENDING) ||
            (step.status === OrderProcessStatus.DRIVER_ACCEPTED &&
              [OrderProcessStatus.DRIVER_ARRIVED_STORE, OrderProcessStatus.DRIVER_PICKED, OrderProcessStatus.DRIVER_ARRIVED_DESTINATION, OrderProcessStatus.COMPLETED].includes(activeOrder.process_status)) ||
            (step.status === OrderProcessStatus.DRIVER_PICKED &&
              [OrderProcessStatus.DRIVER_ARRIVED_DESTINATION, OrderProcessStatus.COMPLETED].includes(activeOrder.process_status))
          ) {
            element.classList.add('active');
          }
        }
      });

      // Update driver info if available
      const driverInfoElement = document.getElementById('driver-info');
      const driverDetailsElement = document.getElementById('driver-details');

      if (activeOrder.driver) {
        driverInfoElement.style.display = 'block';
        driverDetailsElement.innerHTML = `
                    <div><strong>Driver ID:</strong> ${activeOrder.driver.id}</div>
                    <div><strong>Name:</strong> ${activeOrder.driver.name || 'Not available'}</div>
                    <div><strong>Phone:</strong> ${activeOrder.driver.phone || 'Not available'}</div>
                    <div><strong>Vehicle:</strong> ${activeOrder.driver.vehicle_type || 'Not available'}</div>
                `;
      } else {
        driverInfoElement.style.display = 'none';
      }

      // Update cancel button availability
      const cancelButton = document.getElementById('cancel-order-btn');
      if ([OrderProcessStatus.COMPLETED, OrderProcessStatus.CANCELLED].includes(activeOrder.process_status)) {
        cancelButton.disabled = true;
      } else {
        cancelButton.disabled = false;
      }
    }

    // Cancel the active order
    function cancelOrder () {
      if (!socket || !socket.connected || !activeOrder) {
        addLog('Cannot cancel order: Socket not connected or no active order', 'error');
        return;
      }

      socket.emit('cancel_order', {
        orderId: activeOrder.id,
        reason: 'Cancelled by customer'
      });

      addLog('Cancel request sent for order ' + activeOrder.id, 'warning');
    }

    // Calculate distance between two points using Haversine formula
    function calculateDistance (lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of the Earth in km
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c; // Distance in km
      return distance;
    }

    function deg2rad (deg) {
      return deg * (Math.PI / 180);
    }

    // Add log entry
    function addLog (message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const timestamp = new Date().toISOString();

      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${type}">${message}</span>
            `;

      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Clear logs
    function clearLogs () {
      document.getElementById('log-container').innerHTML = '';
      addLog('Logs cleared', 'info');
    }
  </script>
</body>

</html>